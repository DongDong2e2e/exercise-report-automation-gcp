<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
    .dashboard-container, .chat-container { max-width: 1000px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .dashboard-container { padding: 20px; margin-bottom: 20px; }
    h2 { text-align: center; color: #333; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .chart-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; }
    .chart-box h3 { margin-top: 0; text-align: center; font-size: 16px; color: #555;}
    .chat-container { display: flex; flex-direction: column; height: 80vh; max-height: 700px; }
    #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid #ddd; }
    .message { margin-bottom: 15px; display: flex; flex-direction: column; }
    .user-message { align-items: flex-end; }
    .ai-message { align-items: flex-start; }
    .message p { padding: 10px 15px; max-width: 90%; line-height: 1.5; border-radius: 18px; }
    .user-message p { background-color: #007bff; color: white; border-bottom-right-radius: 5px; }
    .ai-message p { background-color: #e9e9eb; color: #333; border-bottom-left-radius: 5px; white-space: pre-wrap; }
    #input-area { display: flex; padding: 10px; }
    #user-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; }
    #send-button { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <h2>ğŸ“Š ë‚˜ì˜ ë§ì¶¤í˜• í”¼íŠ¸ë‹ˆìŠ¤ ëŒ€ì‹œë³´ë“œ</h2>
    <div class="chart-grid">
      <div class="chart-box">
        <h3>Push Strength (ìµœê³  ì¤‘ëŸ‰)</h3>
        <canvas id="pushChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Pull & Hinge Strength (ìµœê³  ì¤‘ëŸ‰)</h3>
        <canvas id="pullChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Leg Strength (ìµœê³  ì¤‘ëŸ‰)</h3>
        <canvas id="legChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>ì¸ë°”ë”” ë³€í™” (3ê°œì›”)</h3>
        <canvas id="inbodyChart"></canvas>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div id="chat-log"></div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”...">
      <button id="send-button" title="ë©”ì‹œì§€ ë³´ë‚´ê¸°">â†’</button>
    </div>
  </div>

  <script>
    const chatLog = document.getElementById('chat-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chartColors = { red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)' };
    
    /**
     * ì—¬ëŸ¬ ìš´ë™ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë¼ì¸ ì°¨íŠ¸ë¡œ ê·¸ë ¤ì£¼ëŠ” ë²”ìš© í•¨ìˆ˜
     */
    function createMovementChart(canvasId, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      // 1. ëª¨ë“  ìš´ë™ì˜ ë‚ ì§œë¥¼ í•©ì³ ì¤‘ë³µì„ ì œê±°í•˜ê³  ì •ë ¬ëœ xì¶• ë ˆì´ë¸” ìƒì„±
      const allLabels = [...new Set(Object.values(data).flatMap(d => d.labels))].sort();
      
      const datasets = Object.keys(data).map((exercise, index) => {
        const colorName = Object.keys(chartColors)[index % Object.keys(chartColors).length];
        const exerciseData = data[exercise];
        
        // 2. allLabelsì— ë§ì¶° ë°ì´í„° í¬ì¸íŠ¸ë¥¼ ì¬ë°°ì—´ (í•´ë‹¹ ë‚ ì§œì— ê¸°ë¡ ì—†ìœ¼ë©´ null)
        const alignedData = allLabels.map(label => {
          const dataIndex = exerciseData.labels.indexOf(label);
          return dataIndex !== -1 ? exerciseData.data[dataIndex] : null;
        });

        return {
          label: exercise,
          data: alignedData,
          borderColor: chartColors[colorName],
          fill: false,
          tension: 0.1,
          borderWidth: 2,
          spanGaps: true // ì¤‘ê°„ì— null ê°’ì´ ìˆì–´ë„ ì„ ì´ ëŠê¸°ì§€ ì•Šê²Œ í•¨
        };
      });

      new Chart(ctx, {
        type: 'line',
        data: { labels: allLabels, datasets: datasets },
        options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top' } } }
      });
    }

    /**
     * ì¸ë°”ë”” ë°ì´í„°ë¥¼ ì´ì¤‘ ì¶• ë¼ì¸ ì°¨íŠ¸ë¡œ ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜
     */
    function createInbodyChart(data) {
      const ctx = document.getElementById('inbodyChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [
            { label: 'ì²´ì¤‘(kg)', data: data.weight, borderColor: chartColors.blue, yAxisID: 'y' },
            { label: 'ê³¨ê²©ê·¼ëŸ‰(kg)', data: data.muscle, borderColor: chartColors.red, yAxisID: 'y' },
            { label: 'ì²´ì§€ë°©ë¥ (%)', data: data.fatPercent, borderColor: chartColors.green, yAxisID: 'y1', borderDash: [5, 5] }
          ]
        },
        options: { responsive: true, scales: { y: { position: 'left', title: { display: true, text: 'kg' } }, y1: { position: 'right', title: { display: true, text: '%' }, grid: { drawOnChartArea: false } } } }
      });
    }

    /**
     * ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ (í…ìŠ¤íŠ¸ ë˜ëŠ” ì°¨íŠ¸ ê°ì²´)
     */
    function appendMessage(sender, content) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
      
      if (sender === 'ai' && typeof content === 'object' && content.type === 'chart') {
        const p = document.createElement('p');
        p.textContent = `ë„¤, ìš”ì²­í•˜ì‹  '${content.title}' ê·¸ë˜í”„ë¥¼ ì¤€ë¹„í–ˆì–´ìš”!`;
        messageDiv.appendChild(p);
        const chartContainer = document.createElement('div');
        chartContainer.style.height = '250px'; chartContainer.style.marginTop = '10px';
        const canvas = document.createElement('canvas');
        chartContainer.appendChild(canvas);
        messageDiv.appendChild(chartContainer);
        new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: content.data.labels, datasets: [{ label: content.title, data: content.data.data, borderColor: chartColors.purple, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false } });
      } else {
        const p = document.createElement('p');
        p.textContent = content;
        messageDiv.appendChild(p);
      }
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    /**
     * ë¡œë”© ìƒíƒœë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
     */
    function showLoader() { 
      const loaderDiv = document.createElement('div'); 
      loaderDiv.id = 'loader'; 
      loaderDiv.classList.add('message', 'ai-message'); 
      loaderDiv.innerHTML = '<p>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–</p>'; 
      chatLog.appendChild(loaderDiv); 
      chatLog.scrollTop = chatLog.scrollHeight; 
    }

    /**
     * ë¡œë”© ìƒíƒœë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
     */
    function removeLoader() { 
      const loader = document.getElementById('loader'); 
      if (loader) loader.remove(); 
    }

    /**
     * ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë°±ì—”ë“œë¡œ ë³´ë‚´ê³  ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
     */
    function handleSend() { 
      const message = userInput.value.trim(); 
      if (!message) return; 
      appendMessage('user', message); 
      userInput.value = ''; 
      userInput.disabled = true; 
      sendButton.disabled = true; 
      showLoader(); 
      google.script.run
        .withSuccessHandler(response => { 
          removeLoader(); 
          appendMessage('ai', response); 
          userInput.disabled = false; 
          sendButton.disabled = false; 
          userInput.focus(); 
        })
        .withFailureHandler(error => { 
          removeLoader(); 
          appendMessage('ai', 'ì£„ì†¡í•´ìš”. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ' + error.message); 
          userInput.disabled = false; 
          sendButton.disabled = false; 
          userInput.focus(); 
        })
        .processUserMessage(message); 
    }

    /**
     * í˜ì´ì§€ ë¡œë”© ì™„ë£Œ ì‹œ ì‹¤í–‰ë  ì´ˆê¸°í™” í•¨ìˆ˜
     */
    window.addEventListener('DOMContentLoaded', () => {
      google.script.run
        .withSuccessHandler(userInfo => {
          appendMessage('ai', `ì•ˆë…•í•˜ì„¸ìš”, ${userInfo.name}ë‹˜! ì €ëŠ” ë‹¹ì‹ ì˜ AI í”¼íŠ¸ë‹ˆìŠ¤ ë¹„ì„œ 'ë²„ë‹ˆ'ì…ë‹ˆë‹¤. ì•„ë˜ ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•˜ì‹œê³ , ê¶ê¸ˆí•œ ì ì€ ì œê²Œ ë¬¼ì–´ë³´ì„¸ìš”!`);
        })
        .getUserInfo();

      google.script.run
        .withSuccessHandler(data => {
          if (Object.keys(data.pushData).length > 0) createMovementChart('pushChart', data.pushData);
          if (Object.keys(data.pullData).length > 0) createMovementChart('pullChart', data.pullData);
          if (Object.keys(data.legData).length > 0) createMovementChart('legChart', data.legData);
          if (data.inbodyData.labels.length > 0) createInbodyChart(data.inbodyData);
        })
        .withFailureHandler(err => console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err))
        .getDashboardData();
    });

    sendButton.addEventListener('click', handleSend);
    userInput.addEventListener('keydown', event => { 
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        handleSend();
      }
    });
  </script>
</body>
</html>
