<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
    .dashboard-container, .chat-container { max-width: 1000px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .dashboard-container { padding: 20px; margin-bottom: 20px; }
    h2 { text-align: center; color: #333; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .chart-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; }
    .chart-box h3 { margin-top: 0; text-align: center; font-size: 16px; color: #555;}
    .chat-container { display: flex; flex-direction: column; height: 80vh; max-height: 700px; }
    #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid #ddd; }
    .message { margin-bottom: 15px; display: flex; flex-direction: column; }
    .user-message { align-items: flex-end; }
    .ai-message { align-items: flex-start; }
    .message p { padding: 10px 15px; max-width: 90%; line-height: 1.5; border-radius: 18px; }
    .user-message p { background-color: #007bff; color: white; border-bottom-right-radius: 5px; }
    .ai-message p { background-color: #e9e9eb; color: #333; border-bottom-left-radius: 5px; white-space: pre-wrap; }
    #input-area { display: flex; padding: 10px; }
    #user-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; }
    #send-button { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <h2>📊 나의 맞춤형 피트니스 대시보드</h2>
    <div class="chart-grid">
      <div class="chart-box">
        <h3>Push Strength (최고 중량)</h3>
        <canvas id="pushChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Pull & Hinge Strength (최고 중량)</h3>
        <canvas id="pullChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Leg Strength (최고 중량)</h3>
        <canvas id="legChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>인바디 변화 (3개월)</h3>
        <canvas id="inbodyChart"></canvas>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div id="chat-log"></div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="궁금한 점을 물어보세요...">
      <button id="send-button" title="메시지 보내기">→</button>
    </div>
  </div>

  <script>
    const chatLog = document.getElementById('chat-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chartColors = { red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)' };
    
    /**
     * 여러 운동 데이터를 하나의 라인 차트로 그려주는 범용 함수
     */
    function createMovementChart(canvasId, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      // 1. 모든 운동의 날짜를 합쳐 중복을 제거하고 정렬된 x축 레이블 생성
      const allLabels = [...new Set(Object.values(data).flatMap(d => d.labels))].sort();
      
      const datasets = Object.keys(data).map((exercise, index) => {
        const colorName = Object.keys(chartColors)[index % Object.keys(chartColors).length];
        const exerciseData = data[exercise];
        
        // 2. allLabels에 맞춰 데이터 포인트를 재배열 (해당 날짜에 기록 없으면 null)
        const alignedData = allLabels.map(label => {
          const dataIndex = exerciseData.labels.indexOf(label);
          return dataIndex !== -1 ? exerciseData.data[dataIndex] : null;
        });

        return {
          label: exercise,
          data: alignedData,
          borderColor: chartColors[colorName],
          fill: false,
          tension: 0.1,
          borderWidth: 2,
          spanGaps: true // 중간에 null 값이 있어도 선이 끊기지 않게 함
        };
      });

      new Chart(ctx, {
        type: 'line',
        data: { labels: allLabels, datasets: datasets },
        options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top' } } }
      });
    }

    /**
     * 인바디 데이터를 이중 축 라인 차트로 그려주는 함수
     */
    function createInbodyChart(data) {
      const ctx = document.getElementById('inbodyChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [
            { label: '체중(kg)', data: data.weight, borderColor: chartColors.blue, yAxisID: 'y' },
            { label: '골격근량(kg)', data: data.muscle, borderColor: chartColors.red, yAxisID: 'y' },
            { label: '체지방률(%)', data: data.fatPercent, borderColor: chartColors.green, yAxisID: 'y1', borderDash: [5, 5] }
          ]
        },
        options: { responsive: true, scales: { y: { position: 'left', title: { display: true, text: 'kg' } }, y1: { position: 'right', title: { display: true, text: '%' }, grid: { drawOnChartArea: false } } } }
      });
    }

    /**
     * 메시지를 채팅창에 추가하는 함수 (텍스트 또는 차트 객체)
     */
    function appendMessage(sender, content) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
      
      if (sender === 'ai' && typeof content === 'object' && content.type === 'chart') {
        const p = document.createElement('p');
        p.textContent = `네, 요청하신 '${content.title}' 그래프를 준비했어요!`;
        messageDiv.appendChild(p);
        const chartContainer = document.createElement('div');
        chartContainer.style.height = '250px'; chartContainer.style.marginTop = '10px';
        const canvas = document.createElement('canvas');
        chartContainer.appendChild(canvas);
        messageDiv.appendChild(chartContainer);
        new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: content.data.labels, datasets: [{ label: content.title, data: content.data.data, borderColor: chartColors.purple, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false } });
      } else {
        const p = document.createElement('p');
        p.textContent = content;
        messageDiv.appendChild(p);
      }
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    /**
     * 로딩 상태를 표시하는 함수
     */
    function showLoader() { 
      const loaderDiv = document.createElement('div'); 
      loaderDiv.id = 'loader'; 
      loaderDiv.classList.add('message', 'ai-message'); 
      loaderDiv.innerHTML = '<p>분석 중입니다... 🤖</p>'; 
      chatLog.appendChild(loaderDiv); 
      chatLog.scrollTop = chatLog.scrollHeight; 
    }

    /**
     * 로딩 상태를 제거하는 함수
     */
    function removeLoader() { 
      const loader = document.getElementById('loader'); 
      if (loader) loader.remove(); 
    }

    /**
     * 사용자 메시지를 백엔드로 보내고 응답을 처리하는 메인 함수
     */
    function handleSend() { 
      const message = userInput.value.trim(); 
      if (!message) return; 
      appendMessage('user', message); 
      userInput.value = ''; 
      userInput.disabled = true; 
      sendButton.disabled = true; 
      showLoader(); 
      google.script.run
        .withSuccessHandler(response => { 
          removeLoader(); 
          appendMessage('ai', response); 
          userInput.disabled = false; 
          sendButton.disabled = false; 
          userInput.focus(); 
        })
        .withFailureHandler(error => { 
          removeLoader(); 
          appendMessage('ai', '죄송해요. 오류가 발생했어요: ' + error.message); 
          userInput.disabled = false; 
          sendButton.disabled = false; 
          userInput.focus(); 
        })
        .processUserMessage(message); 
    }

    /**
     * 페이지 로딩 완료 시 실행될 초기화 함수
     */
    window.addEventListener('DOMContentLoaded', () => {
      google.script.run
        .withSuccessHandler(userInfo => {
          appendMessage('ai', `안녕하세요, ${userInfo.name}님! 저는 당신의 AI 피트니스 비서 '버니'입니다. 아래 대시보드를 확인하시고, 궁금한 점은 제게 물어보세요!`);
        })
        .getUserInfo();

      google.script.run
        .withSuccessHandler(data => {
          if (Object.keys(data.pushData).length > 0) createMovementChart('pushChart', data.pushData);
          if (Object.keys(data.pullData).length > 0) createMovementChart('pullChart', data.pullData);
          if (Object.keys(data.legData).length > 0) createMovementChart('legChart', data.legData);
          if (data.inbodyData.labels.length > 0) createInbodyChart(data.inbodyData);
        })
        .withFailureHandler(err => console.error('대시보드 데이터 로드 실패:', err))
        .getDashboardData();
    });

    sendButton.addEventListener('click', handleSend);
    userInput.addEventListener('keydown', event => { 
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        handleSend();
      }
    });
  </script>
</body>
</html>
