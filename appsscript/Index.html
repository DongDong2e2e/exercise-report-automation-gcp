// =================================================================
// ================= ğŸ“Š ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì œê³µ í•¨ìˆ˜ ğŸ“Š =================
// =================================================================

/**
 * [ìˆ˜ì •ë¨] ëŒ€ì‹œë³´ë“œ ì´ˆê¸° ë¡œë”©ì— í•„ìš”í•œ ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ê³µí•˜ì—¬ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
 * ì‚¬ìš©ìì˜ ì£¼ìš” ìš´ë™ ëª©ë¡ì„ Push, Pull, Legs ì„¸ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
 */
function getDashboardData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const logSheet = ss.getSheetByName(getProjectConfig().STRUCTURED_LOG_SHEET);
  const inbodySheet = ss.getSheetByName(getProjectConfig().INBODY_SHEET);
  
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
  const formatDate = (date) => Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd');
  const threeMonthsAgoStr = formatDate(threeMonthsAgo);

  const logData = logSheet.getRange("A2:H" + logSheet.getLastRow()).getValues()
    .filter(row => row[0] && formatDate(new Date(row[0])) >= threeMonthsAgoStr);
  
  const inbodyData = inbodySheet.getRange("A2:F" + inbodySheet.getLastRow()).getValues()
    .filter(row => row[0] && formatDate(new Date(row[0])) >= threeMonthsAgoStr);

  // ìš´ë™ ê·¸ë£¹ë³„ ë°ì´í„° ì¶”ì¶œì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
  const extractWorkoutData = (exerciseList) => {
    const workoutData = {};
    exerciseList.forEach(exerciseName => {
      const exerciseLogs = logData.filter(row => row[1] && row[1].includes(exerciseName));
      if (exerciseLogs.length === 0) return;

      const dailyMax = {};
      exerciseLogs.forEach(row => {
        const dateStr = formatDate(new Date(row[0]));
        const weight = row[4];
        if (!dailyMax[dateStr] || weight > dailyMax[dateStr]) {
          dailyMax[dateStr] = weight;
        }
      });

      const sortedDates = Object.keys(dailyMax).sort();
      workoutData[exerciseName] = {
        labels: sortedDates,
        data: sortedDates.map(date => dailyMax[date])
      };
    });
    return workoutData;
  };

  // 1. Push ìš´ë™ ë°ì´í„° ì¶”ì¶œ
  const pushExercises = ['ë²¤ì¹˜í”„ë ˆìŠ¤', 'ë¤ë²¨ ìˆ„ë” í”„ë ˆìŠ¤', 'ì¸í´ë¼ì¸ ì²´ìŠ¤íŠ¸ í”„ë ˆìŠ¤'];
  const pushData = extractWorkoutData(pushExercises);
  
  // 2. Pull & Hinge ìš´ë™ ë°ì´í„° ì¶”ì¶œ
  const pullExercises = ['ë£¨ë§ˆë‹ˆì•ˆ ë°ë“œë¦¬í”„íŠ¸', 'í‹°ë°” ë¡œìš°'];
  const pullData = extractWorkoutData(pullExercises);

  // 3. Leg ìš´ë™ ë°ì´í„° ì¶”ì¶œ
  const legExercises = ['ë ˆê·¸ í”„ë ˆìŠ¤', 'ë¸Œì´ ìŠ¤ì¿¼íŠ¸', 'ë¦¬ë²„ìŠ¤ ë¸Œì´ ìŠ¤ì¿¼íŠ¸', 'í™ ì“°ëŸ¬ìŠ¤íŠ¸'];
  const legData = extractWorkoutData(legExercises);

  // 4. ì¸ë°”ë”” ë°ì´í„° ì¶”ì¶œ
  const inbodyChartData = {
    labels: inbodyData.map(row => formatDate(new Date(row[0]))),
    weight: inbodyData.map(row => row[2]),
    muscle: inbodyData.map(row => row[3]),
    fatPercent: inbodyData.map(row => row[5] * 100)
  };

  return {
    pushData,
    pullData,
    legData,
    inbodyData: inbodyChartData
  };
}```
*(ì°¸ê³ : `Code.gs`ì˜ ë‹¤ë¥¸ ë¶€ë¶„ì€ ìˆ˜ì •í•  í•„ìš” ì—†ìŠµë‹ˆë‹¤.)*

#### âœ… Step 2: `index.html` ìˆ˜ì •

HTML êµ¬ì¡°ì™€ ì°¨íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒˆë¡œìš´ 3+1 êµ¬ì¡°ì— ë§ê²Œ ì „ë©´ ìˆ˜ì •í•©ë‹ˆë‹¤.

```html
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
    .dashboard-container, .chat-container { max-width: 1000px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    .dashboard-container { padding: 20px; margin-bottom: 20px; }
    h2 { text-align: center; color: #333; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .chart-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; }
    .chart-box h3 { margin-top: 0; text-align: center; font-size: 16px; color: #555;}

    .chat-container { display: flex; flex-direction: column; height: 80vh; max-height: 700px; }
    #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid #ddd; }
    .message { margin-bottom: 15px; display: flex; flex-direction: column; }
    .user-message { align-items: flex-end; }
    .ai-message { align-items: flex-start; }
    .message p { padding: 10px 15px; max-width: 90%; line-height: 1.5; border-radius: 15px; }
    .user-message p { background-color: #007bff; color: white; border-bottom-right-radius: 0; }
    .ai-message p { background-color: #e9e9eb; color: #333; border-bottom-left-radius: 0; }
    #input-area { display: flex; padding: 10px; }
    #user-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; }
    #send-button { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <h2>ğŸ“Š ë‚˜ì˜ ë§ì¶¤í˜• í”¼íŠ¸ë‹ˆìŠ¤ ëŒ€ì‹œë³´ë“œ</h2>
    <div class="chart-grid">
      <div class="chart-box">
        <h3>Push Strength (ìµœê³  ì¤‘ëŸ‰)</h3>
        <canvas id="pushChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Pull & Hinge Strength (ìµœê³  ì¤‘ëŸ‰)</h3>
        <canvas id="pullChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Leg Strength (ìµœê³  ì¤‘ëŸ‰)</h3>
        <canvas id="legChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>ì¸ë°”ë”” ë³€í™” (3ê°œì›”)</h3>
        <canvas id="inbodyChart"></canvas>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div id="chat-log"></div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”...">
      <button id="send-button" title="ë©”ì‹œì§€ ë³´ë‚´ê¸°">â†’</button>
    </div>
  </div>

  <script>
    const chatLog = document.getElementById('chat-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');

    const chartColors = { red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)' };
    
    // [ìˆ˜ì •ë¨] ë²”ìš© ì°¨íŠ¸ ìƒì„± í—¬í¼ í•¨ìˆ˜
    function createMovementChart(canvasId, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const datasets = Object.keys(data).map((exercise, index) => {
        const colorName = Object.keys(chartColors)[index % Object.keys(chartColors).length];
        return {
          label: exercise,
          data: data[exercise].data,
          borderColor: chartColors[colorName],
          fill: false,
          tension: 0.1,
          borderWidth: 2
        };
      });
      
      const allLabels = [...new Set(Object.values(data).flatMap(d => d.labels))].sort();
      
      datasets.forEach(dataset => {
        const newData = new Array(allLabels.length).fill(null);
        const originalLabels = Object.values(data).find(d => d.labels.length > 0).labels; // ì„ì‹œë°©í¸
        Object.values(data).forEach(d => {
           d.labels.forEach((label, i) => {
               const index = allLabels.indexOf(label);
               if(index !==-1 && d.data[i] !== undefined) {
                  newData[index] = d.data[i];
               }
           });
        });
        
        let found = false;
        for(let key in data) {
           if(data[key].labels.length > 0) {
              originalLabels = data[key].labels;
              found = true;
              break;
           }
        }
        if(!found) return;

        data[datasets[0].label].labels.forEach((label, i) => {
            const index = allLabels.indexOf(label);
            if (index !== -1) {
                newData[index] = data[datasets[0].label].data[i];
            }
        });
        dataset.data = newData;
      });

      new Chart(ctx, {
        type: 'line',
        data: { labels: allLabels, datasets: datasets },
        options: { responsive: true, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top' } } }
      });
    }

    // ì¸ë°”ë”” ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
    function createInbodyChart(data) {
      const ctx = document.getElementById('inbodyChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [
            { label: 'ì²´ì¤‘(kg)', data: data.weight, borderColor: chartColors.blue, yAxisID: 'y' },
            { label: 'ê³¨ê²©ê·¼ëŸ‰(kg)', data: data.muscle, borderColor: chartColors.red, yAxisID: 'y' },
            { label: 'ì²´ì§€ë°©ë¥ (%)', data: data.fatPercent, borderColor: chartColors.green, yAxisID: 'y1' }
          ]
        },
        options: { responsive: true, scales: { y: { position: 'left', title: { display: true, text: 'kg' } }, y1: { position: 'right', title: { display: true, text: '%' }, grid: { drawOnChartArea: false } } } }
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      appendMessage('ai', "ì•ˆë…•í•˜ì„¸ìš”! ë‚˜ë§Œì˜ ë§ì¶¤í˜• ëŒ€ì‹œë³´ë“œë¥¼ ì¤€ë¹„í–ˆì–´ìš”. ê¶ê¸ˆí•œ ì ì€ ë­ë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”!");

      google.script.run
        .withSuccessHandler(data => {
          if (Object.keys(data.pushData).length > 0) createMovementChart('pushChart', data.pushData);
          if (Object.keys(data.pullData).length > 0) createMovementChart('pullChart', data.pullData);
          if (Object.keys(data.legData).length > 0) createMovementChart('legChart', data.legData);
          if (data.inbodyData.labels.length > 0) createInbodyChart(data.inbodyData);
        })
        .withFailureHandler(err => console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err))
        .getDashboardData();
    });
    
    // (ì´í•˜ ì±—ë´‡ ê´€ë ¨ JSëŠ” ì´ì „ ë‹µë³€ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
    function appendMessage(sender, text) { /* ì´ì „ ë‹µë³€ê³¼ ë™ì¼ */ }
    function showLoader() { /* ì´ì „ ë‹µë³€ê³¼ ë™ì¼ */ }
    function removeLoader() { /* ì´ì „ ë‹µë³€ê³¼ ë™ì¼ */ }
    function handleSend() { /* ì´ì „ ë‹µë³€ê³¼ ë™ì¼ */ }
    sendButton.addEventListener('click', handleSend);
    userInput.addEventListener('keydown', event => { if (event.key === 'Enter') handleSend(); });

    // --- ë³µì‚¬í•´ì˜¬ ì±—ë´‡ JS í•¨ìˆ˜ë“¤ ---
    function appendMessage(sender, content) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
      if (sender === 'ai' && typeof content === 'object' && content.type === 'chart') {
        const p = document.createElement('p');
        p.textContent = `ë„¤, ìš”ì²­í•˜ì‹  '${content.title}' ê·¸ë˜í”„ë¥¼ ì¤€ë¹„í–ˆì–´ìš”!`;
        messageDiv.appendChild(p);
        const chartContainer = document.createElement('div');
        chartContainer.style.height = '250px'; chartContainer.style.marginTop = '10px';
        const canvas = document.createElement('canvas');
        chartContainer.appendChild(canvas);
        messageDiv.appendChild(chartContainer);
        new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: content.data.labels, datasets: [{ label: content.title, data: content.data.data, borderColor: chartColors.purple, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false } });
      } else {
        const p = document.createElement('p');
        p.textContent = content;
        messageDiv.appendChild(p);
      }
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    function showLoader() { const loaderDiv = document.createElement('div'); loaderDiv.id = 'loader'; loaderDiv.classList.add('message', 'ai-message'); loaderDiv.innerHTML = '<p>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–</p>'; chatLog.appendChild(loaderDiv); chatLog.scrollTop = chatLog.scrollHeight; }
    function removeLoader() { const loader = document.getElementById('loader'); if (loader) loader.remove(); }
    function handleSend() { const message = userInput.value.trim(); if (!message) return; appendMessage('user', message); userInput.value = ''; userInput.disabled = true; sendButton.disabled = true; showLoader(); google.script.run.withSuccessHandler(response => { removeLoader(); appendMessage('ai', response); userInput.disabled = false; sendButton.disabled = false; userInput.focus(); }).withFailureHandler(error => { removeLoader(); appendMessage('ai', 'ì£„ì†¡í•´ìš”. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ' + error.message); userInput.disabled = false; sendButton.disabled = false; userInput.focus(); }).processUserMessage(message); }
  </script>
</body>
</html>
