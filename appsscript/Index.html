<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; margin: 0; padding: 10px; background-color: #f4f4f9; }
    #chat-container { max-width: 700px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 90vh; }
    #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid #ddd; }
    .message { margin-bottom: 15px; display: flex; flex-direction: column; }
    .user-message { align-items: flex-end; }
    .ai-message { align-items: flex-start; }
    .message p { padding: 10px 15px; max-width: 80%; line-height: 1.5; }
    .user-message p { background-color: #007bff; color: white; border-radius: 15px 15px 0 15px; }
    .ai-message p { background-color: #e9e9eb; color: #333; border-radius: 15px 15px 15px 0; white-space: pre-wrap; }
    /* [ì¶”ê°€ë¨] ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .ai-message p strong { font-weight: 600; }
    .ai-message p ul { padding-left: 20px; margin: 5px 0; }
    #input-area { display: flex; padding: 10px; }
    #user-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; }
    #send-button { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .loader { text-align: center; }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="chat-log">
      <!-- ì²« ì¸ì‚¬ëŠ” ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. -->
    </div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="ì§€ë‚œ ì£¼ ìŠ¤ì¿¼íŠ¸ ê¸°ë¡ ì•Œë ¤ì¤˜...">
      <!-- [ìˆ˜ì •ë¨] ì ‘ê·¼ì„±ì„ ìœ„í•œ title ì†ì„± ì¶”ê°€ -->
      <button id="send-button" title="ë©”ì‹œì§€ ë³´ë‚´ê¸°">â†’</button>
    </div>
  </div>

  <script>
    const chatLog = document.getElementById('chat-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');

    // [ì¶”ê°€ë¨] ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” ê°„ë‹¨í•œ íŒŒì„œ
    function simpleMarkdownParser(text) {
        // **bold** -> <strong>bold</strong>
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // * list -> <ul><li>list</li></ul> (ê°„ë‹¨í•œ ëª©ë¡ ì²˜ë¦¬)
        text = text.replace(/^\s*\*\s(.*)/gm, '<ul><li>$1</li></ul>');
        text = text.replace(/<\/ul>\n<ul>/g, ''); // ì—°ì†ëœ ëª©ë¡ í•©ì¹˜ê¸°
        return text;
    }

    // [ìˆ˜ì •ë¨] ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜ (HTML ë Œë”ë§ ì§€ì›)
    function appendMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
      
      const p = document.createElement('p');
      if (sender === 'ai') {
        p.innerHTML = simpleMarkdownParser(text); // AI ë©”ì‹œì§€ëŠ” ë§ˆí¬ë‹¤ìš´ íŒŒì‹±
      } else {
        p.textContent = text; // ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ
      }
      
      messageDiv.appendChild(p);
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function showLoader() {
      const loaderDiv = document.createElement('div');
      loaderDiv.id = 'loader';
      loaderDiv.classList.add('message', 'ai-message');
      loaderDiv.innerHTML = '<p>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! ğŸ¤–</p>';
      chatLog.appendChild(loaderDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function removeLoader() {
      const loader = document.getElementById('loader');
      if (loader) {
        loader.remove();
      }
    }

    function handleSend() {
      const message = userInput.value.trim();
      if (!message) return;

      appendMessage('user', message);
      userInput.value = '';
      userInput.disabled = true;
      sendButton.disabled = true;
      showLoader();

      google.script.run
        .withSuccessHandler(response => {
          removeLoader();
          appendMessage('ai', response);
          userInput.disabled = false;
          sendButton.disabled = false;
          userInput.focus();
        })
        .withFailureHandler(error => {
          removeLoader();
          appendMessage('ai', 'ì£„ì†¡í•´ìš”. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ' + error.message);
          userInput.disabled = false;
          sendButton.disabled = false;
          userInput.focus();
        })
        .processUserMessage(message);
    }

    // [ì¶”ê°€ë¨] ì›¹ ì•±ì´ ë¡œë“œë  ë•Œ ì‚¬ìš©ì ì´ë¦„ì„ ê°€ì ¸ì™€ ì²« ì¸ì‚¬ë¥¼ ì„¤ì •í•˜ëŠ” ê¸°ëŠ¥
    window.addEventListener('DOMContentLoaded', () => {
      google.script.run
        .withSuccessHandler(userInfo => {
          const welcomeMessage = `ì•ˆë…•í•˜ì„¸ìš”, ${userInfo.name}ë‹˜! ì €ëŠ” ë‹¹ì‹ ì˜ ìš´ë™ ê¸°ë¡ì„ ë¶„ì„í•´ì£¼ëŠ” AI í”¼íŠ¸ë‹ˆìŠ¤ ë¹„ì„œ 'ë²„ë‹ˆ'ì…ë‹ˆë‹¤. ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?`;
          appendMessage('ai', welcomeMessage);
        })
        .withFailureHandler(error => {
          const welcomeMessage = `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë‹¹ì‹ ì˜ ìš´ë™ ê¸°ë¡ì„ ë¶„ì„í•´ì£¼ëŠ” AI í”¼íŠ¸ë‹ˆìŠ¤ ë¹„ì„œ 'ë²„ë‹ˆ'ì…ë‹ˆë‹¤. ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?`;
          appendMessage('ai', welcomeMessage); // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€
        })
        .getUserInfo();
    });

    sendButton.addEventListener('click', handleSend);
    userInput.addEventListener('keydown', event => {
      if (event.key === 'Enter' && !event.shiftKey) { // Shift+EnterëŠ” ì¤„ë°”ê¿ˆ í—ˆìš©
        event.preventDefault(); // Enterí‚¤ ê¸°ë³¸ ë™ì‘(ì¤„ë°”ê¿ˆ) ë°©ì§€
        handleSend();
      }
    });
  </script>
</body>
</html>
